<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="sample">

	<select id="selectBoardList" parameterType="hashmap" resultType="hashmap">
       SELECT
           (
               SELECT
                   COUNT(*) 
               FROM 
                   TB_BOARD
               WHERE 
                   DEL_GB = 'N'
                   <if test="category != null and category != ''">
			       AND category = #{category}
			       </if>
           ) AS TOTAL_COUNT ,
           IDX,
           TITLE,
           HIT_CNT,
           DATE_FORMAT(CREA_DTM, '%Y-%m-%d') AS CREA_DTM,
           category,
           address
       FROM
           TB_BOARD
       WHERE
           DEL_GB= 'N'
       <if test="category != null and category != ''">
       AND category = #{category}
       </if>
       ORDER BY 
           IDX DESC
       LIMIT #{START} , #{END} 

	</select>

	<insert id="insertBoard" parameterType="hashmap" useGeneratedKeys="true" keyProperty="IDX"> 
	<![CDATA[ 
		INSERT INTO TB_BOARD 
			(
				TITLE, 
				CONTENTS, 
				HIT_CNT, 
				DEL_GB, 
				CREA_DTM, 
				CREA_ID,
				category,
				lat,
				lon,
				address
				) 
				VALUES 
				(
				#{TITLE},
				#{CONTENTS},
				0, 
				'N',
				now(),
				'Admin',
				#{category},
				#{lat},
				#{lon},
				#{address}
			) 
	]]>
	</insert>
	
	<insert id="insertBoardTour" parameterType="hashmap" useGeneratedKeys="true" keyProperty="IDX"> 
	<![CDATA[ 
		INSERT INTO TOUR_BOARD 
			(
				IDX,
				parking,
				fee,
				use_time,
				closed_day
				) 
				VALUES 
				(
				#{IDX},
				#{parking},
				#{fee},
				#{use_time},
				#{closed_day}				
			) 
	]]>
	</insert>

	<update id="updateHitCnt" parameterType="hashmap">
	<![CDATA[
		UPDATE TB_BOARD 
		SET
			HIT_CNT = IFNULL(HIT_CNT, 0) + 1
		WHERE
			IDX = #{IDX}	
	]]>
	</update>

	<select id="selectBoardDetail" parameterType="hashmap"
		resultType="hashmap">
	<![CDATA[
	SELECT
			IDX,
			HIT_CNT,
			CREA_ID,
			DATE_FORMAT(CREA_DTM, '%Y-%m-%d') AS CREA_DTM,
			TITLE,
			CONTENTS,
			category,
			lat,
			lon,
			address
		FROM
			TB_BOARD
		WHERE
			IDX = #{IDX}	
	]]>
	</select>


<select id="selectBoardDetailTour" parameterType="hashmap"
		resultType="hashmap">
	<![CDATA[
	SELECT
			TB.IDX,
			TB.HIT_CNT,
			TB.CREA_ID,
			DATE_FORMAT(TB.CREA_DTM, '%Y-%m-%d') AS CREA_DTM,
			TB.TITLE,
			TB.CONTENTS,
			TB.category,
			TB.lat,
			TB.lon,
			TB.address,
			tour.parking,
			tour.fee,
			tour.use_time,
			tour.closed_day
		FROM
			TB_BOARD as TB
		JOIN tour_board as tour
		ON TB.IDX = tour.IDX
		WHERE
			TB.IDX = #{IDX}	
	]]>
	</select>
	<update id="updateBoard" parameterType="hashmap"> 
	<![CDATA[ 
		UPDATE TB_BOARD 
		SET 
			TITLE = #{TITLE}, 
			CONTENTS = #{CONTENTS},
			category = #{category},
			lat = #{lat},
			lon = #{lon},
			address = #{address}
		WHERE 
			IDX = #{IDX} 
	]]>
	</update>
	
	<update id="updateBoardTour" parameterType="hashmap"> 
	<![CDATA[ 
		UPDATE tour_board 
		SET 
			IDX = #{IDX}, 
			parking = #{parking},
			fee = #{fee},
			use_time = #{use_time},
			closed_day = #{closed_day}
		WHERE 
			IDX = #{IDX} 
	]]>
	</update>
	
	<update id="deleteBoard" parameterType="hashmap"> 
	<![CDATA[ 
		UPDATE TB_BOARD 
		SET 
			DEL_GB = 'Y' 
		WHERE 
			IDX = #{IDX} 
	]]> 
	</update>

	<insert id="insertFile" parameterType="hashmap"> 
	<![CDATA[ 
		INSERT INTO TB_FILE 
			( 
				BOARD_IDX, 
				ORIGINAL_FILE_NAME, 
				STORED_FILE_NAME, 
				FILE_SIZE, 
				CREA_ID 
			) 
			VALUES 
			( 
			#{BOARD_IDX}, 
			#{ORIGINAL_FILE_NAME}, 
			#{STORED_FILE_NAME}, 
			#{FILE_SIZE}, 
			'Admin' 
		) 
	]]> 
	</insert>

	<select id="selectFileList" parameterType="hashmap" resultType="hashmap"> 
		<![CDATA[ 
			SELECT 
				IDX, 
				ORIGINAL_FILE_NAME, 
				ROUND(FILE_SIZE/1024,1)
				AS FILE_SIZE 
			FROM 
				TB_FILE 
			WHERE 
				BOARD_IDX = #{IDX} 
				AND DEL_GB = 'N' 
		]]> 
	</select>

	<update id="deleteFileList" parameterType="hashmap"> 
		<![CDATA[ 
			UPDATE TB_FILE 
			SET 
				DEL_GB = 'Y' 
			WHERE 
				BOARD_IDX = #{IDX} 
		]]> 
	</update> 
	
	<update id="updateFile" parameterType="hashmap"> 
		<![CDATA[ 
			UPDATE TB_FILE 
			SET 
				DEL_GB = 'N' 
			WHERE 
				IDX = #{FILE_IDX} 
		]]> 
	</update>
	
	<select id="selectBoardList2" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
       SELECT
           (
               SELECT
                   COUNT(*) 
               FROM 
                   TB_BOARD
               WHERE 
                   DEL_GB = 'N'
           ) AS TOTAL_COUNT ,
           IDX,
           TITLE,
           HIT_CNT,
           DATE_FORMAT(CREA_DTM, '%Y-%m-%d') AS CREA_DTM,
           category,
           lat,
           lon,
           ( 6371 * acos( cos( radians( lat ) ) * cos( radians( #{lat} ) ) * cos( radians( #{lon} ) - radians( lon ) ) 
			+ sin( radians( lat ) ) * sin( radians( #{lat} ) ) ) ) AS distance
       FROM
           TB_BOARD
       WHERE
           DEL_GB= 'N'
     	and category = #{category}
     	and (lat != #{lat} and lon != #{lon} )
       HAVING distance < 5 
       ORDER BY 
           IDX DESC
       LIMIT #{START} , #{END} 
   ]]>
	</select>

</mapper>

